---
title: "The Future of Military Engines: Contract Analysis"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---


# ================================================================================
# The Future of Military Engines
# Created by Gabriel Coll 
# Maintained by Greg Sanders
# ================================================================================

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.
```{r Setup}
library(tidyverse)
library(csis360)
source("theme/chart_theme.R")
source("theme/money_labels.R")

# local_path<-"F:\\Users\\gsanders\\Documents\\Repositories\\Lookup-Tables\\style\\"
# local_path<-"K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\"
load(file="app/engine_contract.Rdata")
# load(file="data/just_engine_contract.Rdata")
labels_and_colors<-prepare_labels_and_colors(engine_contracts %>% select(-PricingMechanism,-MajorCommandName))#, path=local_path
column_key<-get_column_key(engine_contracts)# ,path=local_path

# engine_contracts %>% filter(csistransactionid==104709800)
```

## Project
```{r PreprocessProject}
summary(factor(engine_contracts$SimpleArea))

engine_contracts<-
  engine_contracts[,!colnames(engine_contracts) %in% c("TopProject","rank_2020","rank_total")]

colnames(engine_contracts)[colnames(engine_contracts)=="Action_Obligation_Then_Year_Then_Year"]<-
  "Action_Obligation_Then_Year"

colnames(engine_contracts)[colnames(engine_contracts)=="Action_Obligation_Then_Year_OMB23_GDP21"]<-
  "Action_Obligation_OMB23_GDP21"

topplat<-engine_contracts %>% group_by (Project.Name,SimpleArea) %>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB23_GDP21,0)))%>%
              group_by (SimpleArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB23_GDP21)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topplat %>% arrange(desc(Action_Obligation_OMB23_GDP21))


topplat$TopProject<-
  ifelse(topplat$rank_2020<=7 | topplat$rank_total<=7,topplat$Project.Name,NA)

engine_contracts<-left_join(engine_contracts,topplat %>% select(-Action_Obligation_OMB23_GDP21,-Action_Obligation_2020,
                                                               -rank_2020,-rank_total),
          by=c("Project.Name","SimpleArea"))

engine_contracts$TopProject[is.na(engine_contracts$TopProject) & !is.na(engine_contracts$Project.Name)]<-
  "Other Labeled Project"


summary(factor(engine_contracts$TopProject))

TPOlist<-c("JSF (F-35)","Advanced Engine Development","F-100 Engine","F/A-22")
engine_contracts$TopProjectOverall[!is.na(engine_contracts$Project.Name)]<-"Other labeled project"
engine_contracts$TopProjectOverall[is.na(engine_contracts$Project.Name)]<-"Unlabeled project"
engine_contracts$TopProjectOverall[engine_contracts$Project.Name %in% TPOlist]<-
  engine_contracts$Project.Name[engine_contracts$Project.Name %in% TPOlist]
summary(factor(engine_contracts$TopProjectOverall))


Shortlist<-c("JSF (F-35)","Advanced Engine Development")
# engine_contracts$SimpleArea.engines[!is.na(engine_contracts$Project.Name)]<-"Other labeled project"
# engine_contracts$TopProjectOverall[is.na(engine_contracts$Project.Name)]<-"Unlabeled project"
engine_contracts$SimpleArea.engines<-NA
engine_contracts$SimpleArea.engines[engine_contracts$Project.Name %in% Shortlist]<-
  engine_contracts$Project.Name[engine_contracts$Project.Name %in% Shortlist]
engine_contracts$SimpleArea.engines[is.na(engine_contracts$SimpleArea.engines)&!is.na(engine_contracts$SimpleArea)]<-
  paste("Other",engine_contracts$SimpleArea[is.na(engine_contracts$SimpleArea.engines)&!is.na(engine_contracts$SimpleArea)])
summary(factor(engine_contracts$SimpleArea.engines))

```

## PSC
```{r PreprocessPSC}

summary(factor(engine_contracts$ProjectPlatform))


engine_contracts<-
  engine_contracts[,!colnames(engine_contracts) %in% c("topPSC","rank_2020","rank_total","TopPScode","TopPStext")]

topPSC<-engine_contracts %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText,SimpleArea) %>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB23_GDP21,0)))%>%
              group_by (SimpleArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB23_GDP21)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topPSC %>% arrange(desc(Action_Obligation_OMB23_GDP21))

topPSC$TopPScode<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCode,NA)
topPSC$TopPStext<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCodeText,NA)


engine_contracts<-left_join(engine_contracts,topPSC %>% select(-Action_Obligation_OMB23_GDP21,-Action_Obligation_2020,
                                                               -rank_2020,-rank_total,-ProductOrServiceCodeText),
          by=c("ProductOrServiceCode","SimpleArea"))

engine_contracts$TopPScode[is.na(engine_contracts$TopPScode) & !is.na(engine_contracts$ProductOrServiceCode)]<-
  "Other Labeled PSC"
engine_contracts$TopPStext[is.na(engine_contracts$TopPStext) & !is.na(engine_contracts$ProductOrServiceCode)]<-
  "Other Labeled PSC"

engine_contracts$TopPStext<-factor_wrap(engine_contracts$TopPStext)

summary(factor(engine_contracts$TopPStext))


```
## Service investigation
```{r invest}
write.csv(file="data\\service_invest.csv",engine_contracts %>%
  select(SimpleArea,ClaimantProgramCode,PlatformPortfolio,ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea,Action_Obligation_OMB23_GDP21,SubCustomer.engines,Contracting_Agency_ID,ContractingOfficeID,fundingrequestingagencyid,fundingrequestingofficeid,ProjectID,Project.Name) %>%
    group_by(SimpleArea,ClaimantProgramCode,PlatformPortfolio,ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea,SubCustomer.engines,Contracting_Agency_ID,ContractingOfficeID,fundingrequestingagencyid,fundingrequestingofficeid,ProjectID,Project.Name) %>%
    summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE)),row.names = FALSE)
  

write.csv(file="data\\service_invest_year.csv",engine_contracts %>%
  select(SimpleArea,ClaimantProgramCode,PlatformPortfolio,ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea,Action_Obligation_OMB23_GDP21,SubCustomer.engines,Contracting_Agency_ID,ContractingOfficeID,fundingrequestingagencyid,fundingrequestingofficeid,ProjectID,Project.Name,Fiscal_Year) %>%
    group_by(SimpleArea,ClaimantProgramCode,PlatformPortfolio,ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea,SubCustomer.engines,Contracting_Agency_ID,ContractingOfficeID,fundingrequestingagencyid,fundingrequestingofficeid,ProjectID,Project.Name,Fiscal_Year) %>%
    summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE)),row.names = FALSE)
```
A1B is sometimes being overriden by other platform codes (as known). $391m over the period including a $39m deobligation from Ord. and missiles.

I reclassified the following projects 'ITEP','C-20 ACFT','UH-60 UTTAS BLACK HAWK','B-52 STRATO FORTRESS','A-4 SKYHAWK','E-3A','REPAIR SHIP AIRCRAFT','T-400' and will be comfortable limiting to Aircraft Platform Portfolio henceforth. Around 9  million under missile defense, but PAC-3 related primarily so not taking a closer look at MDA.

Nearly $3b of engine related service code work on aircraft codes A1C 41 million on A1A. 700 million on C9E but 4.76 billion on claimant program code S1.

Not sure why there's a 145 million deobligation for peacekeeper missile with aircraft engine type, maybe look into that.

Offices to allow for service
F4FDAN Air Force Life Cycle Management Center WWU F22 PGM OFC
N0000019 Nav Air
N61340 Naval Air Warfare Center Training Systems Division
N68335	NAVAIR WARFARE CTR AIRCRAFT DIV

Together these top codes get at $3.8 b of the 8.7 b of services.

The next two are not obviously relevant, so a good place to stop.


W9127S army corps of engineers
N64498 navy surface warfare

# ================================================================================
# charting engines 
## engine contracts 
```{r ec}
(
  total <- engine_contracts %>%
    group_by(Fiscal_Year) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
    ggplot() +
    geom_area(aes(y = Action_Obligation_OMB23_GDP21, x = Fiscal_Year), alpha = .9 , stat = "identity") +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    ) +
    scale_y_continuous(labels = money_labels) +
    chart_theme +
    ggtitle("DoD Aircraft Engine Contract Obligations") +
    xlab("Fiscal Year") +
    ylab("Constant 2021 $")
)

ggsave(
  "charts/amount_total.svg",
  total,
  device = "svg",
  width = 8,
  height = 6,
  units = "in"
)



write.csv(total$data %>%
            spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/amount_total.csv",row.names = FALSE)
```

## engine contracts by Vendor Size 
```{r vsize}
(
  Shiny.VendorSize <- engine_contracts %>%
    filter(Shiny.VendorSize != "Unlabeled") %>%
    group_by(Fiscal_Year, Shiny.VendorSize) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
    ggplot() +
    geom_area(aes(y = Action_Obligation_OMB23_GDP21, x = Fiscal_Year), alpha = .9, stat = "identity") +
    facet_wrap(~ Shiny.VendorSize, nrow = 2) +
    chart_theme +
    ggtitle("DoD Aircraft Engine Contract Obligations by Vendor Size") +
    xlab("Fiscal Year") +
    ylab("Constant 2021 $") +
    scale_y_continuous(labels = money_labels) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )
)




ggsave(
  "charts/amount_vendor_size.svg",
  Shiny.VendorSize,
  device = "svg",
  width = 8,
  height = 6,
  units = "in"
)

write.csv(Shiny.VendorSize$data,# %>%
            # spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/amount_vendor_size.csv",row.names = FALSE)

# --------------------------------------------------------------------------------
sum((engine_contracts %>% filter(Competition.multisum == "Unlabeled"))$Action_Obligation_OMB23_GDP21 )
```

###Top VEndor
```{r TopVendor}
Top_Vendor<-
engine_contracts %>% group_by(AllContractor,Fiscal_Year)%>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21)
            # Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB23_GDP21,0))
            )%>%
              group_by (Fiscal_Year) %>%
    mutate(rank_FY=rank(desc(Action_Obligation_OMB23_GDP21)),
           pObl=Action_Obligation_OMB23_GDP21/sum(Action_Obligation_OMB23_GDP21))%>%
  arrange(Fiscal_Year,rank_FY)

Top_Vendor %>% dplyr::filter( rank_FY<=5)

```

## Competition
### engine  CompetitionClassification  
```{r Competition}
(
  Competition <- engine_contracts %>%
    filter(Competition.multisum != "Unlabeled") %>%
    group_by(Fiscal_Year, Competition.multisum) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
    mutate(Competition = factor(
      Competition.multisum,
      levels=c("2+ Offers" ,
               "1 Offer"   ,
               "No Comp."),
      labels = c(
        "Effective Competition",
        "Competition with single offer",
        "No Competition"
      )
    )) %>%
    ggplot() +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    ) +
    geom_area(aes(y = Action_Obligation_OMB23_GDP21, x = Fiscal_Year), alpha = .9, stat = "identity") +
    facet_wrap(~ Competition, nrow = 1) +
    chart_theme +
    ggtitle("DoD Aircraft Engine Contract Obligations\nby Extent of Competition") + 
    xlab("Fiscal Year") +
    ylab("Constant 2021 $") +
    scale_y_continuous(labels = money_labels) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )
)

ggsave(
  "charts/amount_competition.svg",
  Competition,
  device = "svg",
  width = 8,
  height = 4.25,
  units = "in"
)




write.csv(Competition$data,# %>%
            # spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/amount_competition.csv",row.names = FALSE)





(
  Competition_Share <- engine_contracts %>%
    # filter(Competition.multisum != "Unlabeled") %>%
    # group_by(Fiscal_Year, Competition.multisum,SimpleArea) %>%
    group_by(Fiscal_Year, Competition.multisum) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
    # group_by(Fiscal_Year, SimpleArea) %>%#Competition.multisum,
    group_by(Fiscal_Year) %>%#Competition.multisum,
    mutate(
      amount_share = Action_Obligation_OMB23_GDP21/ sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE),
      Competition = factor(
      Competition.multisum,
      levels=c("No Comp.",
               "1 Offer"   ,
               "2+ Offers" ,
               "Unlabeled"),
      labels = c(
        "No Competition",
        "Competition with single offer",
        "Effective Competition",
        "Unlabeled"
      )
    )) %>%
    ggplot() +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    ) +
    geom_line(aes(y = amount_share, 
                  x = Fiscal_Year,
                  linetype=Competition)) +#, alpha = .9, stat = "identity"
    # facet_wrap(~ SimpleArea, nrow = 1) +#Competition
    chart_theme +
    scale_y_continuous(label=scales::percent_format(accuracy = 1)) +#,breaks=c(-0.5,0,0.5,1,1.5)
    ggtitle("DoD Aircraft Engine Contract Obligations\nby Extent of Competition") +
    xlab("Fiscal Year") +
    ylab("Percent of Contract Obligations") +
    # scale_y_continuous(labels = money_labels) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )+theme(legend.position = "bottom")+
    guides(linetype=guide_legend(nrow=2))+
             scale_linetype_manual(values=c("solid","twodash","dashed","dotted"))
)


ggsave(
  "charts/share_competition.svg",
  Competition_Share,
  device = "svg",
  width = 5.5,
  height = 4,
  units = "in"
)

write.csv(Competition_Share$data,# %>%
            # spread(key=Fiscal_Year, value=amount_share),
          file="charts/share_competition.csv",row.names = FALSE)
```

### Comp. Subcust PSR (Fig 6)   
```{r CusComp}
engine_contracts %>% group_by(Fiscal_Year) %>% summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
engine_contracts %>% filter(Fiscal_Year==2021) %>% group_by(Competition.sum) %>% summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
summary(factor(engine_contracts$ProjectName))


(
CustCompMultiShare<-build_plot(
  data=engine_contracts %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SubCustomer.engines", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Share of Obligations")
)

(
CustCompMulti<-build_plot(
  data=engine_contracts %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SubCustomer.engines", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")
)




engine_contracts %>% filter(Competition.sum =="Unlabeled" & Fiscal_Year>=2019) %>% group_by(CompetitionClassification)%>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))

ggsave600dpi(file="charts//EngineCompSubCust.png", CustCompMulti,  
             width=9, height= 5.5, units="in",size=14, lineheight=1.2
             )
ggsave600dpi(file="charts//EngineCompSubCustShare.svg", CustCompMultiShare,  
             width=9, height= 5.5, units="in",size=14, lineheight=1.2
             )


# ggsave600dpi(gridExtra::grid.arrange(pSA+labs(caption=NULL),pSA),file="charts/SimpleAreaBoth.svg",width=6.5,height=2.5,size = 11,lineheight = 1.2)
(both<-gridExtra::grid.arrange(CustCompMulti+labs(caption=NULL,x=NULL)+facet_wrap(SubCustomer.engines~.,nrow=1)+
                                 theme(legend.position="none")+
                          labs(y="Obligations\n(Constant 2021 $s)")+
            scale_x_date(NULL,labels = scales::label_date("'%y"),date_breaks = "5 years"),
                         CustCompMultiShare+
         facet_wrap(SubCustomer.engines~.,nrow=1)+
            scale_x_date("Fiscal Year",labels = scales::label_date("'%y"),date_breaks = "5 years")+
           labs(caption="Source: FPDS and CSIS Analysis."))
)
ggsave(file="charts/EngineCompSubCustiBoth.svg",
       both,
       width=6.5,height=4.5,dpi=600)
ggsave(file="charts/EngineCompSubCustiBoth.png",
       both,
       width=6.5,height=4.5)
       
write.csv(file="charts//EngineCompSubCust.csv",row.names = FALSE, na = "",
          CustCompMulti$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SubCustomer.engines,Competition.multisum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(SubCustomer.engines,Competition.multisum))


write.csv(file="charts//EngineCompSubCust_cur.csv",row.names = FALSE, na = "",
          engine_contracts %>% group_by(SubCustomer.engines,Competition.multisum,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.engines,Competition.multisum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%arrange(SubCustomer.engines,Competition.multisum))


```

### Comp. Cust/PSR
```{r CusCompPSR}
(
ToplineCompMultiPSR<-build_plot(
  data=engine_contracts %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SubCustomer.engines", #facet_var
  second_var="SimpleArea.AETP",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")
)



(
ToplineCompMultiSimpleArea<-build_plot(
  data=engine_contracts %>% filter(Fiscal_Year>=2000)),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SubCustomer.engines", #facet_var
  second_var = "SimpleArea",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")
)
  



```


##Simple Area

```{r SimpleArea}


(
  SimpleArea<-build_plot(
    data=engine_contracts %>% filter(!is.na(SimpleArea)),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="SimpleArea.engines", #color_var
    facet_var="SimpleArea.AETP", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    # scale_y_continuous(expand=expansion(add=c(0,1.5e9)),label = scales::unit_format(unit = "M", scale = 1e-6))+
    theme(legend.position = "bottom")+
    labs(y="Obligations (Constant 2021 $s)")+
    facet_grid(SimpleArea.AETP~.,scales="free_y",space="free_y")
)


ggsave600dpi(SimpleArea,file="charts/SimpleArea.png",width=5,height=6,size = 11)
ggsave600dpi(SimpleArea,file="charts/SimpleArea.svg",width=3.25,height=6,size = 11)

write.csv(file="charts//SimpleArea.csv",row.names = FALSE, na = "",
          SimpleArea$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(SimpleArea.AETP,SimpleArea.engines),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(SimpleArea.AETP,SimpleArea.engines))

```


### R&D phase

````{r RnDphase}

(
  RnDphase<-build_plot(
    data=engine_contracts %>% filter(SimpleArea=="R&D"),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="ProductServiceOrRnDarea", #color_var
    # facet_var="Competition.sum", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("charts//psr_RnDphase.svg", RnDphase,
             width=12, height= 6, units="in",size=12, lineheight=1.2
)
# 
# 
# write.csv(file="charts//psr_RnDPhase.csv",row.names = FALSE, na = "",
#           pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
#             arrange(ProductServiceOrRnDarea))


output_TY<-engine_contracts %>% filter(SimpleArea=="R&D") %>%
  format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductOrServiceArea",
                       labels_and_colors=labels_and_colors) %>%
  pivot_wider(id_cols=c(ProductServiceOrRnDarea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
  arrange(ProductOrServiceArea)


write.csv(file="charts//psr_RnDphase_current.csv",row.names = FALSE, na = "",
          output_TY)
# 
# wb <- loadWorkbook("charts//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
# createSheet(wb, name = "R&D")
# writeWorksheet(wb, output_TY, sheet = "R&D", startRow = 15, startCol = 13)
# saveWorkbook(wb)
```


### Products

````{r ProductArea}

(
  ProductArea<-build_plot(
    data=engine_contracts %>% filter(SimpleArea=="Products"),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="ProductOrServiceArea", #color_var
    # facet_var="Competition.sum", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)")
)


(
  ProductArea<-build_plot(
    data=engine_contracts %>% filter(SimpleArea=="Products"),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="PlatformPortfolio", #color_var
    # facet_var="Competition.sum", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("charts//psr_ProductArea.svg", ProductArea,
             width=12, height= 6, units="in",size=12, lineheight=1.2
)
# 
# 
# write.csv(file="charts//psr_RnDPhase.csv",row.names = FALSE, na = "",
#           pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
#             arrange(ProductServiceOrRnDarea))


output_TY<-engine_contracts %>% filter(SimpleArea=="Products") %>%
  format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductOrServiceArea",
                       labels_and_colors=labels_and_colors) %>%
  pivot_wider(id_cols=c(ProductOrServiceArea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
  arrange(ProductOrServiceArea)


write.csv(file="charts//psr_Product_current.csv",row.names = FALSE, na = "",
          output_TY)
# 
# wb <- loadWorkbook("charts//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
# createSheet(wb, name = "R&D")
# writeWorksheet(wb, output_TY, sheet = "R&D", startRow = 15, startCol = 13)
# saveWorkbook(wb)

```

### Service

````{r ServiceArea}

(
  ServiceArea<-build_plot(
    data=engine_contracts %>% filter(SimpleArea=="Services"),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="ProductOrServiceArea", #color_var
    # facet_var="Competition.sum", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("charts//psr_ServiceArea.svg", ServiceArea,
             width=12, height= 6, units="in",size=12, lineheight=1.2
)
# 
# 
# write.csv(file="charts//psr_RnDPhase.csv",row.names = FALSE, na = "",
#           pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
#             arrange(ProductServiceOrRnDarea))


output_TY<-engine_contracts %>% filter(SimpleArea=="Services") %>%
  format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductOrServiceArea",
                       labels_and_colors=labels_and_colors) %>%
  pivot_wider(id_cols=c(ProductOrServiceArea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
  arrange(ProductOrServiceArea)


write.csv(file="charts//psr_Service_current.csv",row.names = FALSE, na = "",
          output_TY)
# 
# wb <- loadWorkbook("charts//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
# createSheet(wb, name = "R&D")
# writeWorksheet(wb, output_TY, sheet = "R&D", startRow = 15, startCol = 13)
# saveWorkbook(wb)

```
## engine contracts by Contract Type 
```{r Pricing}
levels(factor(engine_contracts$PricingMechanism))
(
  PricingMechanism <- engine_contracts %>%
    filter(PricingMechanism != "Other") %>%
    group_by(Fiscal_Year, PricingMechanism) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
    mutate(PricingMechanism = factor(
      PricingMechanism,
      levels = c(
        "Cost+",
        "Combination",
        "Time/Mat.",
        "Fixed",
        "Unlabeled"
      ),
      labels = c(
        "Cost Reimbursement",
        "Combination",
        "Time and Materials",
        "Fixed Price",
        "Unlabeled"
      )
    )) %>%
    ggplot() +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    ) +
    geom_area(aes(y = Action_Obligation_OMB23_GDP21, x = Fiscal_Year), alpha = .9, stat = "identity") +
    facet_wrap(~ PricingMechanism, nrow = 1) +
    chart_theme +
    ggtitle("DoD Aircraft Engine Contract Obligations by Contract Type") +
    xlab("Fiscal Year") +
    ylab("Constant 2021 $") +
    scale_y_continuous(labels = money_labels) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )
)

ggsave(
  "charts/amount_contract_type.svg",
  PricingMechanism,
  device = "svg",
  width = 12,
  height = 4,
  units = "in"
)

write.csv(PricingMechanism$data,# %>%
            # spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/amount_contract_type.csv",row.names = FALSE)

```

# SubCustomer PSR (Fig 3)
## Build Plot
```{r SubCustomerPSR}
summary(factor(engine_contracts$SubCustomer.engines))

(
SubCustomerPSR<-build_plot(
  data=engine_contracts %>% filter(
      !is.na(SimpleArea.AETP)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SimpleArea.engines", #facet_var
  facet_var="SimpleArea.AETP", #color_var
  second_var="SubCustomer.engines",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
    scale_x_date(labels = scales::label_date("'%y"),date_breaks = "5 years")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2021 $s)")+
  scale_y_continuous(expand=expansion(add=c(0,1.5e9)),label = scales::unit_format(unit = "B", scale = 1e-9))+
    facet_grid(SimpleArea.AETP~SubCustomer.engines,scales="free_y",space="free_y")
  # facet_grid(SimpleArea.AETP~SubCustomer.engines, scales = "free_y",space="free_y")
)

# ggsave600dpi("..//Output//subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave("Charts//subcustomer_PSR.svg", SubCustomerPSR+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 6, units="in"
             )

write.csv(file="charts//subcustomer_PSR.csv",row.names = FALSE, na = "",
          SubCustomerPSR$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SubCustomer.engines,SimpleArea.AETP,SimpleArea.engines),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(SubCustomer.engines,SimpleArea.AETP,SimpleArea.engines))

```

## super facet
```{r ServiceArea}
#This could be done in fewer steps but on skimming it seems to check out.

total <- engine_contracts %>%
  group_by(Fiscal_Year) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  mutate(SimpleArea = "Total") %>%
  as.data.frame(.)

total_category <- engine_contracts %>%
  group_by(Fiscal_Year, SimpleArea) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  as.data.frame(.)

total <- total %>%
  rbind(total_category) %>%
  mutate(SubCustomer = "Total")

army <- engine_contracts %>%
  filter(SubCustomer == "Army") %>%
  group_by(Fiscal_Year) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  mutate(SimpleArea = "Total") %>%
  as.data.frame(.)

army_category <- engine_contracts %>%
  filter(SubCustomer == "Army") %>%
  group_by(Fiscal_Year, SimpleArea) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  as.data.frame(.)

army <- army %>%
  rbind(army_category) %>%
  mutate(SubCustomer = "Army")

navy <- engine_contracts %>%
  group_by(Fiscal_Year) %>%
  filter(SubCustomer == "Navy") %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  mutate(SimpleArea = "Total") %>%
  mutate(SimpleArea = as.factor(SimpleArea)) %>%
  as.data.frame(.)

navy_category <- engine_contracts %>%
  filter(SubCustomer == "Navy") %>%
  group_by(Fiscal_Year, SimpleArea) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  as.data.frame(.)

navy <- navy %>%
  rbind(navy_category) %>%
  mutate(SubCustomer = "Navy")

air_force <- engine_contracts %>%
  group_by(Fiscal_Year) %>%
  filter(SubCustomer == "Air Force") %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  mutate(SimpleArea = "Total") %>%
  mutate(SimpleArea = as.factor(SimpleArea)) %>%
  as.data.frame(.)

air_force_category <- engine_contracts %>%
  filter(SubCustomer == "Air Force") %>%
  group_by(Fiscal_Year, SimpleArea) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  as.data.frame(.)

air_force <- air_force %>%
  rbind(air_force_category) %>%
  mutate(SubCustomer = "Air Force")

dla <- engine_contracts %>%
  group_by(Fiscal_Year) %>%
  filter(SubCustomer == "DLA") %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  mutate(SimpleArea = "Total") %>%
  mutate(SimpleArea = as.factor(SimpleArea)) %>%
  as.data.frame(.)

dla_category <- engine_contracts %>%
  filter(SubCustomer == "DLA") %>%
  group_by(Fiscal_Year, SimpleArea) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  as.data.frame(.)

dla <- dla %>%
  rbind(dla_category) %>%
  mutate(SubCustomer = "DLA")

(
  super_facet <- total %>%
    rbind(army, navy, air_force, dla) %>%
    mutate(
      SubCustomer = factor(SubCustomer, levels = c("Army",
                                                   "Navy",
                                                   "Air Force",
                                                   "DLA",
                                                   "Total")),
      SimpleArea = factor(SimpleArea, levels = c("Products",
                                                 "Services",
                                                 "R&D",
                                                 "Total"))
    ) %>%
    
    ggplot() +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    ) +
    geom_area(aes(x = Fiscal_Year, y = Action_Obligation_OMB23_GDP21), alpha = .9) +
    facet_grid(SubCustomer ~ SimpleArea) +
    chart_theme +
    xlab("Fiscal Year") +
    ylab("Constant 2021 $") +
    ggtitle("DoD Aircraft Engine Contract Obligations by service and SimpleArea") +
    scale_y_continuous(labels = money_labels) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )+
    labs(caption="Obligations for the remainder of DoD and with an unlabeled customer or area are excluded from the graph.")
)


ggsave(
  "charts/amount_customer_category.svg",
  super_facet,
  device = "svg",
  width = 10,
  height = 12,
  units = "in"
)

write.csv(super_facet$data %>%
            spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/amount_customer_category.csv",row.names = FALSE)
```

# Simple Area and Top Projects


## R&D
```{r RnD}

(
RnDpsc<-build_plot(
  data=engine_contracts %>% filter(SimpleArea.AETP=="R&D and AETP"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
  
)
  


(
RnD<-build_plot(
  data=engine_contracts %>% filter(SimpleArea.AETP=="R&D and AETP"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)
  
  
  write.csv(file="charts//RnD_project_cur.csv",row.names = FALSE,na = "",
            engine_contracts %>% filter(SimpleArea=="R&D")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```

## Products
```{r Products}

(
ProductsPSC<-build_plot(
  data=engine_contracts %>% filter(SimpleArea.AETP=="Products"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)
 

(
Products<-build_plot(
  data=engine_contracts %>% filter(SimpleArea.AETP=="Products"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)
  
  
  write.csv(file="charts//products_project_cur.csv",row.names = FALSE,na = "",
            engine_contracts %>% filter(SimpleArea.AETP=="Products")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```

## Services
```{r Services}

(
ServicesPSC<-build_plot(
  data=engine_contracts %>% filter(SimpleArea.AETP=="Services"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)
 

(
Services<-build_plot(
  data=engine_contracts %>% filter(SimpleArea.AETP=="Services"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)
  
  
  write.csv(file="charts//Services_project_cur.csv",row.names = FALSE,na = "",
            engine_contracts %>% filter(SimpleArea.AETP=="Services")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```


# ================================================================================
# charting engines and topline 

## join engines and topline 
```{r JoinEngineTopline}
engine_contracts <- engine_contracts %>%
  mutate(type = "Engines")

topline_contracts <- topline_contracts %>%
  mutate(type = "Topline")
colnames(topline_contracts)[colnames(topline_contracts)=="ContractingSubCustomer"]<-"SubCustomer"
topline_contracts$SimpleArea<-factor(topline_contracts$SimpleArea)
levels(topline_contracts$SimpleArea)<-
  list("Products"=c("Products","Products (All)"),
       'Services'=c("Services","Services (Non-R&D)"),
       "R&D"=c("R&D"),
       "Total"="Total",
       'Unlabeled'="Unlabeled"
  )

# engine_contracts <- engine_contracts %>%
#   select(Fiscal_Year, SubCustomer, SimpleArea, Action_Obligation_OMB23_GDP21, type)

comparison_contracts <- engine_contracts %>%
  select(Fiscal_Year,dFYear, SubCustomer, SimpleArea,SimpleArea.AETP, Action_Obligation_OMB23_GDP21, type) %>%
  rbind(topline_contracts %>%
          select(Fiscal_Year,dFYear, SubCustomer, SimpleArea, SimpleArea.AETP,Action_Obligation_OMB23_GDP21, type)) %>%
  group_by(Fiscal_Year,dFYear, SubCustomer, SimpleArea,SimpleArea.AETP, type) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE))




dyear <- comparison_contracts %>%
  group_by() %>%
  dplyr::rename(Action_Obligation_OMB23_GDP21.lagged = Action_Obligation_OMB23_GDP21) %>%
  mutate(Fiscal_Year = Fiscal_Year + 1) # %>%
# select(-fyb)

# comparison_contracts <- comparison_contracts %>% filter(Fiscal_Year >= 2001)
#Add lagged year
sumcheck<-sum(comparison_contracts$Action_Obligation_OMB23_GDP21,na.rm=TRUE)
comparison_contracts <- comparison_contracts %>%
  left_join(dyear, by = c("Fiscal_Year", "SubCustomer", "SimpleArea", "type"))# %>%
if(sumcheck!=sum(comparison_contracts$Action_Obligation_OMB23_GDP21,na.rm=TRUE)) stop("Sum Check Error")


dyear <- comparison_contracts %>%
  filter(Fiscal_Year==2000) %>%
  dplyr::rename(Action_Obligation_OMB23_GDP21.2000 = Action_Obligation_OMB23_GDP21) %>%
  group_by()%>%
  select(-Action_Obligation_OMB23_GDP21.lagged,-Fiscal_Year)

#Add 2000
sumcheck<-sum(comparison_contracts$Action_Obligation_OMB23_GDP21,na.rm=TRUE)
comparison_contracts <- comparison_contracts %>%
  left_join(dyear, by = c("SubCustomer", "SimpleArea", "type")) %>%
  mutate(amount_change = Action_Obligation_OMB23_GDP21 - Action_Obligation_OMB23_GDP21.lagged,
         baseline_change = Action_Obligation_OMB23_GDP21 - Action_Obligation_OMB23_GDP21.2000) #%>% 
if(sumcheck!=sum(comparison_contracts$Action_Obligation_OMB23_GDP21,na.rm=TRUE)) stop("Sum Check Error")





rm(dyear)

(
  comparison_contracts_overall <- comparison_contracts %>%
    group_by(Fiscal_Year,dFYear type) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.lagged = sum(Action_Obligation_OMB23_GDP21.lagged, na.rm = TRUE),
                     amount_change = sum(amount_change, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.2000 = sum(Action_Obligation_OMB23_GDP21.2000, na.rm = TRUE),
                     baseline_change = sum(baseline_change, na.rm = TRUE)) %>%
    mutate(amount_percent_change = (amount_change) / Action_Obligation_OMB23_GDP21.lagged,
           baseline_percent_change = (baseline_change) / Action_Obligation_OMB23_GDP21.2000) #%>%
  # dplyr::rename(Action_Obligation_OMB23_GDP21 = Action_Obligation_OMB23_GDP21) %>%
  # select(Fiscal_Year, Action_Obligation_OMB23_GDP21, amount_change, amount_percent_change, type) #%>%
  # This has already been done, which is good, as I don't htink it makes sense to sum percent changes like that.
  # group_by(Fiscal_Year, type) %>%
  # dplyr::summarise(
  #   Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE),
  #   amount_change = sum(amount_change, na.rm = TRUE),
  #   amount_percent_change = sum(amount_percent_change, na.rm = TRUE)
  # )
)
```

## percent change comparison 

```{r pChange}

# 
(
  graph_contracts_overall <- comparison_contracts_overall %>% filter(Fiscal_Year>=2000) %>%
    mutate(type = factor(type, levels = c("Topline", "Engines"))) %>%
    ggplot() +
    geom_line(
      aes(x = Fiscal_Year, y = baseline_percent_change),
      alpha = .9,
      color = "#554449",
      size = 1
    ) +
    geom_hline(
      yintercept = 0,
      alpha = .5,
      color = "#554449",
      size = .5,
      linetype = "dotted"
    ) +
    facet_wrap(~ type) +
    chart_theme +
    ggtitle("Change in Aircraft Engine Contract Obligations") +
    xlab("Fiscal Year") +
    ylab("Cumulative Percent Change (2000=0%), Inflation Adjusted") +
    scale_y_continuous(labels = scales::percent) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )
)

ggsave(
  "charts/percent_change_total.svg",
  graph_contracts_overall,
  width = 9,
  height = 6,
  units = "in",
  device = "svg"
)

write.csv(graph_contracts_overall$data,# %>%
            # spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/percent_change_total.csv",row.names = FALSE)

```


## percent change comparison by SubCustomer


```{r pSubCust}
(
  comparison_contracts_subcustomer <- comparison_contracts %>%
    group_by(Fiscal_Year, SubCustomer, type) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.lagged = sum(Action_Obligation_OMB23_GDP21.lagged, na.rm = TRUE),
                     amount_change = sum(amount_change, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.2000 = sum(Action_Obligation_OMB23_GDP21.2000, na.rm = TRUE),
                     baseline_change = sum(baseline_change, na.rm = TRUE)) %>%
    mutate(amount_percent_change = (amount_change) / Action_Obligation_OMB23_GDP21.lagged,
           baseline_percent_change = (baseline_change) / Action_Obligation_OMB23_GDP21.2000) #%>%
)

levels(factor(comparison_contracts_subcustomer$type))
max((comparison_contracts_subcustomer %>% 
       filter(SubCustomer=="Other DoD" &
                type =="Engines"))$Action_Obligation_OMB23_GDP21
)

(
  graph_contracts_subcustomer <- comparison_contracts_subcustomer %>%
    filter(!is.na(SubCustomer) & SubCustomer %in% c("Total",
                                                    "Army",
                                                    "Navy",
                                                    "Air Force",
                                                    "DLA")) %>%
     filter(Fiscal_Year>=2000) %>%
    group_by() %>%
    mutate(SubCustomer = factor(
      SubCustomer, levels = c("Total",
                              "Army",
                              "Navy",
                              "Air Force",
                              "DLA"
      )
    )) %>%
    mutate(type = factor(type, levels = c("Topline", "Engines"))) %>%
    ggplot() +
    geom_line(
      aes(x = Fiscal_Year, y = baseline_percent_change),
      alpha = .9,
      color = "#554449",
      size = 1
    ) +
    geom_hline(
      yintercept = 0,
      alpha = .5,
      color = "#554449",
      size = .5,
      linetype = "dotted"
    ) +
    
    facet_grid(type ~ SubCustomer) +
    chart_theme +
    #scale_x_continuous(breaks = seq(2000, 2020, by = 2),
    #labels = function(x) {substring(as.character(x), 3, 4)})+
    #scale_y_continuous(limits = c(0:750)) +
    ggtitle("Change in Aircraft Engine Contract Obligations") +
    xlab("Fiscal Year") +
    ylab("Cumulative Percent Change (2000=0%), Inflation Adjusted") +
    scale_y_continuous(labels = scales::percent) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )+
    labs(caption="Obligations for the remainder of DoD and with an unlabeled customer are excluded from the graph.")
)

ggsave(
  "charts/percent_change_customer.svg",
  graph_contracts_subcustomer,
  width = 9,
  height = 6,
  units = "in",
  device = "svg"
)

write.csv(graph_contracts_subcustomer$data,# %>%
            # spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/percent_change_customer.csv",row.names = FALSE)
```


## percent change comparison by SimpleArea 


```{r pArea}

(
  comparison_contracts_area <- comparison_contracts %>%
    group_by(Fiscal_Year, SimpleArea, type) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.lagged = sum(Action_Obligation_OMB23_GDP21.lagged, na.rm = TRUE),
                     amount_change = sum(amount_change, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.2000 = sum(Action_Obligation_OMB23_GDP21.2000, na.rm = TRUE),
                     baseline_change = sum(baseline_change, na.rm = TRUE)) %>%
    mutate(amount_percent_change = (amount_change) / Action_Obligation_OMB23_GDP21.lagged,
           baseline_percent_change = (baseline_change) / Action_Obligation_OMB23_GDP21.2000) #%>%
)

(
  graph_contracts_area <- comparison_contracts_area %>%
    filter(!is.na(SimpleArea) & !SimpleArea %in% c("Services","Unlabeled")) %>%
     filter(Fiscal_Year>=2000) %>%
    # mutate(SimpleArea = factor(SimpleArea, levels = c("Products",
    #                                               # "Services",
    #                                               "R&D"))) %>%
    mutate(type = factor(type, levels = c("Topline", "Engines"))) %>%
    ggplot() +
    geom_line(
      aes(x = Fiscal_Year, y = baseline_percent_change),
      alpha = .9,
      color = "#554449",
      size = 1
    ) +
    geom_hline(
      yintercept = 0,
      alpha = .5,
      color = "#554449",
      size = .5,
      linetype = "dotted"
    ) +
    facet_grid(type ~ SimpleArea) +
    chart_theme +
    ggtitle("Change in Aircraft Engine Contract Obligations") +
    xlab("Fiscal Year") +
    ylab("Cumulative Percent Change (2000=0%), Inflation Adjusted") +
    scale_y_continuous(labels = scales::percent) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )+
    labs(caption="Unlabeled and services obligations are not shown.")
)



ggsave(
  "charts/percent_change_category.svg",
  graph_contracts_area,
  width = 9,
  height = 6,
  units = "in",
  device = "svg"
)

write.csv(graph_contracts_area$data, #%>%
            # spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/percent_change_category.csv",row.names = FALSE)
```


## Product / R&D and topline.

```{r areatopline}



  comparison_contracts_total <-
    comparison_contracts %>%
    group_by(Fiscal_Year, type) %>%
    dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.lagged = sum(Action_Obligation_OMB23_GDP21.lagged, na.rm = TRUE),
                     amount_change = sum(amount_change, na.rm = TRUE),
                     Action_Obligation_OMB23_GDP21.2000 = sum(Action_Obligation_OMB23_GDP21.2000, na.rm = TRUE),
                     baseline_change = sum(baseline_change, na.rm = TRUE)) %>%
    mutate(amount_percent_change = (amount_change) / Action_Obligation_OMB23_GDP21.lagged,
           baseline_percent_change = (baseline_change) / Action_Obligation_OMB23_GDP21.2000) #%>%
comparison_contracts_total$SimpleArea<-"Total"
(comparison_contracts_area_total<-rbind(comparison_contracts_total,
                                       comparison_contracts_area)

)

summary(factor(comparison_contracts_area_total$SimpleArea))
(
  graph_contracts_overall_area <- comparison_contracts_area_total %>%
    filter(!is.na(SimpleArea) & !SimpleArea %in% c("Services","Unlabeled")) %>%
    filter(!is.na(SimpleArea) & !SimpleArea %in% c("Services","Unlabeled")&
             Fiscal_Year>=2000) %>%
    mutate(type = factor(type, levels = c("Topline", "Engines"))) %>%
    ggplot() +
    geom_line(
      aes(x = Fiscal_Year, 
          y = baseline_percent_change,
          linetype=SimpleArea),
      alpha = .9,
      color = "#554449",
      size = 1
    ) +
    geom_hline(
      yintercept = 0,
      alpha = .5,
      color = "#554449",
      size = .5,
      linetype = "dotted"
    ) +
    facet_wrap(~ type) +
    chart_theme +
    ggtitle("Change in Aircraft Engine Contract Obligations") +
    xlab("Fiscal Year") +
    ylab("Cumulative Percent Change, Inflation Adjusted (2000=0%)") +
    scale_y_continuous(labels = scales::percent, breaks = c(-0.5,0,0.5,1,1.5)) +
    scale_x_continuous(
      breaks = seq(2000, 2020, by = 2),
      labels = function(x) {
        substring(as.character(x), 3, 4)
      }
    )+scale_linetype_manual(
      values=c("solid","dotted","dashed")
    )
)

ggsave(
  "charts/percent_change_total_area.svg",
  graph_contracts_overall_area,
  width = 9,
  height = 6,
  units = "in",
  device = "svg"
)

write.csv(graph_contracts_overall_area$data, #%>%
            # spread(key=Fiscal_Year, value=Action_Obligation_OMB23_GDP21),
          file="charts/percent_change_total_area.csv",row.names = FALSE)

```
# Percent of Topline
## Join
```{r}

aircraft<-topline_contracts %>% filter(PlatformPorfolio.engine=="Aircraft")%>%
  mutate(type="Aircraft")


percent_contracts <- engine_contracts %>% 
  select(Fiscal_Year,dFYear, SubCustomer.engines, SimpleArea.AETP, Action_Obligation_OMB23_GDP21, type) %>%
  rbind(topline_contracts %>% filter(Fiscal_Year>=2000)%>%
          select(Fiscal_Year,dFYear, SubCustomer.engines, SimpleArea.AETP, Action_Obligation_OMB23_GDP21, type)) %>%
    rbind(aircraft %>% filter(Fiscal_Year>=2000)%>%
          select(Fiscal_Year,dFYear, SubCustomer.engines, SimpleArea.AETP, Action_Obligation_OMB23_GDP21, type)) %>%
  group_by(Fiscal_Year,dFYear, SubCustomer.engines, SimpleArea.AETP, type) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21 = sum(Action_Obligation_OMB23_GDP21, na.rm = TRUE)) %>%
  pivot_wider(names_from=type, values_from=Action_Obligation_OMB23_GDP21) %>%
  group_by(Fiscal_Year,dFYear, SubCustomer.engines, SimpleArea.AETP) %>%
  dplyr::summarise(Engines = sum(Engines, na.rm = TRUE),
                   Topline = sum(Topline, na.rm = TRUE),
                   Aircraft = sum(Aircraft, na.rm = TRUE))


```
##Simple Area (Fig. 1)

```{r pSimpleArea.AETP}
pSimpleArea.AETP<-percent_contracts %>%
  group_by(Fiscal_Year,dFYear, SimpleArea.AETP) %>%
  dplyr::summarise(Engines = sum(Engines, na.rm = TRUE),
                   Aircraft = sum(Aircraft, na.rm = TRUE),
                   Topline = sum(Topline, na.rm = TRUE))%>%
  mutate(pToplineArea=Engines/Topline,
         pAircraftArea=Engines/Aircraft)%>%
  pivot_longer(cols=c(pToplineArea,pAircraftArea),names_to = "MetricName")

(
  pSA<-build_plot(
    data=pSimpleArea.AETP %>% filter(!is.na(SimpleArea.AETP)) ,
    chart_geom = "Line Chart",
    share = FALSE,
    labels_and_colors=prepare_labels_and_colors(pSimpleArea.AETP,path=local_path),
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="value", #VAR.y.variable
    color_var="MetricName", #color_var
    facet_var="SimpleArea.AETP", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+scale_y_continuous(labels=scales::label_percent())+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Engines as a Percent of Topline\nor Aircraft Portfolio Obligations")
    # facet_grid(SimpleArea.AETP~.,scales="free_y")
)

ggsave600dpi(pSA,file="charts/pSimpleArea.svg",width=6.5,height=2.5,size = 11,lineheight = 1.2)

ggsave600dpi(gridExtra::grid.arrange(pSA+labs(caption=NULL),pSA),
             file="charts/pSimpleArea.svg",width=6.5,height=2.5,size = 11,lineheight = 1.2)

(both<-gridExtra::grid.arrange(SimpleArea+facet_wrap(~SimpleArea.AETP)+labs(caption=NULL)+
                                 labs(y="Obligations\n(Constant 2021 $s)")+
                            scale_x_date(labels = scales::label_date("'%y"),date_breaks = "5 years")+
                            theme(legend.position="right"),
                          pSA+
                            scale_x_date("Fiscal Year",labels = scales::label_date("'%y"),date_breaks = "5 years")+
                            labs(
                                      caption=
                                        "Source: Federal Procurement Data System (FPDS) and CSIS analysis."))
    )
ggsave(file="charts/SimpleAreaBoth.svg",
       both,
       width=6.5,height=4.5)
       

write.csv(file="charts//pSimpleArea.csv",row.names = FALSE, na = "",
          pSA$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SimpleArea.AETP,MetricName),
                        names_from=Fiscal_Year,values_from=value))

```


##SubCustomer.engines

```{r pSimpleCust}
pSubCustomer<-percent_contracts %>%
  group_by(Fiscal_Year,dFYear, SubCustomer.engines) %>%
  dplyr::summarise(Engines = sum(Engines, na.rm = TRUE),
                   Aircraft = sum(Aircraft, na.rm = TRUE),
                   Topline = sum(Topline, na.rm = TRUE))%>%
  mutate(pTopline=Engines/Topline,
         pAircraft=Engines/Aircraft)%>%
  pivot_longer(cols=c(pTopline,pAircraft))

(
  pSC<-build_plot(
    data=pSubCustomer,
    chart_geom = "Line Chart",
    share = FALSE,
    # labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="value", #VAR.y.variable
    color_var="name", #color_var
    facet_var="SubCustomer.engines", #facet_var
    column_key=column_key,
    format=FALSE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)")+
    coord_cartesian(ylim=c(0,0.5))
    # facet_grid(Subc~.,scales="free_y")
)


ggsave600dpi(pSC,file="charts/pSubCustomerJPO.svg",width=6.5,height=4,size = 11)

write.csv(file="charts//pSubCustomerJPO.csv",row.names = FALSE, na = "",
          pSC$data%>% #mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SubCustomer.engines,name),
                        names_from=Fiscal_Year,values_from=value))
```